# üîÑ Diagramas de Flujo - AI Service LanguageAI

## üìã Resumen Ejecutivo

El sistema LanguageAI utiliza m√∫ltiples servicios de IA para generar contenido educativo, incluyendo:
- **Generaci√≥n de palabras y expresiones** con definiciones, ejemplos y traducciones
- **Chat interactivo** para aprendizaje de idiomas
- **Generaci√≥n de ex√°menes** personalizados por nivel CEFR
- **Generaci√≥n de im√°genes** para contenido visual
- **Generaci√≥n de audio** para pronunciaci√≥n
- **Traducci√≥n en tiempo real**

---

## üèóÔ∏è Arquitectura General del Sistema

```mermaid
graph TB
    subgraph "Frontend (React + TypeScript)"
        UI[Interfaz de Usuario]
        Chat[Componentes de Chat]
        Forms[Formularios de Generaci√≥n]
        Admin[Panel de Administraci√≥n]
    end
    
    subgraph "Backend (Node.js + Express)"
        Routes[Rutas API]
        Controllers[Controladores]
        Services[Servicios de IA]
        Middleware[Middleware de Auth]
    end
    
    subgraph "Servicios de IA"
        OpenAI[OpenAI API]
        DALL-E[Generaci√≥n de Im√°genes]
        TTS[Text-to-Speech]
    end
    
    subgraph "Base de Datos"
        MongoDB[(MongoDB)]
        Words[(Colecci√≥n Words)]
        Expressions[(Colecci√≥n Expressions)]
        Exams[(Colecci√≥n Exams)]
        Users[(Colecci√≥n Users)]
    end
    
    subgraph "Almacenamiento"
        Cloudinary[Cloudinary]
        Audio[Archivos de Audio]
        Images[Im√°genes Generadas]
    end
    
    UI --> Routes
    Routes --> Controllers
    Controllers --> Services
    Services --> OpenAI
    Services --> DALL-E
    Services --> TTS
    Controllers --> MongoDB
    Services --> Cloudinary
```

---

## üîÑ Flujo Principal de Generaci√≥n de Contenido

### 1. Generaci√≥n de Palabras (Words)

```mermaid
sequenceDiagram
    participant U as Usuario
    participant F as Frontend
    participant B as Backend
    participant AI as OpenAI
    participant DB as MongoDB
    participant C as Cloudinary
    
    U->>F: Ingresa palabra nueva
    F->>B: POST /api/generate/generate-wordJson
    B->>AI: Genera definici√≥n, ejemplos, tipo
    AI-->>B: JSON con datos de la palabra
    B->>DB: Guarda palabra en MongoDB
    B->>C: Genera y sube imagen (opcional)
    B-->>F: Respuesta con palabra creada
    F-->>U: Muestra palabra generada
```

### 2. Generaci√≥n de Expresiones

```mermaid
sequenceDiagram
    participant U as Usuario
    participant F as Frontend
    participant B as Backend
    participant AI as OpenAI
    participant DB as MongoDB
    
    U->>F: Ingresa expresi√≥n nueva
    F->>B: POST /api/generate/generate-wordJson
    B->>AI: Genera definici√≥n, ejemplos, contexto
    Note over AI: Incluye traducci√≥n al espa√±ol
    AI-->>B: JSON con datos de la expresi√≥n
    B->>DB: Guarda expresi√≥n en MongoDB
    B-->>F: Respuesta con expresi√≥n creada
    F-->>U: Muestra expresi√≥n generada
```

---

## üí¨ Flujo del Sistema de Chat

### 3. Chat con Palabras/Expresiones

```mermaid
sequenceDiagram
    participant U as Usuario
    participant F as Frontend
    participant B as Backend
    participant AI as OpenAI
    participant DB as MongoDB
    
    U->>F: Escribe mensaje en chat
    F->>B: POST /api/generate/generate-text (stream)
    B->>DB: Obtiene historial del chat
    B->>AI: Genera respuesta contextualizada
    Note over AI: Incluye historial y contexto
    AI-->>B: Stream de respuesta
    B-->>F: Stream de respuesta
    F-->>U: Muestra respuesta en tiempo real
    B->>DB: Guarda mensaje en historial
```

---

## üìù Flujo de Generaci√≥n de Ex√°menes

### 4. Generaci√≥n de Ex√°menes Personalizados

```mermaid
flowchart TD
    A[Usuario selecciona opciones] --> B{Validar par√°metros}
    B -->|V√°lidos| C[Generar prompt del sistema]
    B -->|Inv√°lidos| D[Error de validaci√≥n]
    
    C --> E[Crear prompt con nivel CEFR]
    E --> F[Incluir t√≥picos de gram√°tica]
    F --> G[Configurar tipos de preguntas]
    G --> H[Llamar a OpenAI GPT-4o-mini]
    
    H --> I{Respuesta v√°lida?}
    I -->|S√≠| J[Parsear JSON de preguntas]
    I -->|No| K[Reintentar o error]
    
    J --> L[Validar estructura de preguntas]
    L --> M{Validaci√≥n exitosa?}
    M -->|S√≠| N[Guardar examen en DB]
    M -->|No| O[Error de validaci√≥n]
    
    N --> P[Retornar examen generado]
    
    style A fill:#e1f5fe
    style P fill:#c8e6c9
    style D fill:#ffcdd2
    style O fill:#ffcdd2
```

### 5. Detalles del Prompt de Examen

```mermaid
graph LR
    subgraph "Prompt del Sistema"
        A[Contexto del nivel CEFR]
        B[Tipos de preguntas permitidas]
        C[T√≥picos de gram√°tica]
        D[Restricciones de formato]
        E[Instrucciones de validaci√≥n]
    end
    
    subgraph "Validaciones"
        F[Unicidad de respuestas]
        G[Formato JSON correcto]
        H[N√∫mero exacto de preguntas]
        I[Distribuci√≥n de tipos]
    end
    
    subgraph "Salida"
        J[T√≠tulo del examen]
        K[Slug URL-friendly]
        L[Array de preguntas]
        M[Explicaciones HTML]
    end
```

---

## üñºÔ∏è Flujo de Generaci√≥n de Im√°genes

### 6. Generaci√≥n y Almacenamiento de Im√°genes

```mermaid
sequenceDiagram
    participant U as Usuario
    participant F as Frontend
    participant B as Backend
    participant AI as DALL-E
    participant C as Cloudinary
    participant DB as MongoDB
    
    U->>F: Solicita generar imagen
    F->>B: POST /api/generate/generate-image-*
    B->>AI: Genera imagen con prompt
    AI-->>B: Imagen en base64
    B->>C: Sube imagen a Cloudinary
    C-->>B: URL de la imagen
    B->>DB: Actualiza entidad con nueva imagen
    B-->>F: Respuesta con URL actualizada
    F-->>U: Muestra nueva imagen
```

---

## üîä Flujo de Generaci√≥n de Audio

### 7. Text-to-Speech

```mermaid
flowchart TD
    A[Usuario ingresa texto] --> B[Validar texto]
    B --> C[Seleccionar voz]
    C --> D[Generar audio con OpenAI TTS]
    D --> E[Convertir a formato compatible]
    E --> F[Almacenar en servidor]
    F --> G[Retornar URL del audio]
    
    style A fill:#e1f5fe
    style G fill:#c8e6c9
```

---

## üîÑ Flujo de Traducci√≥n

### 8. Traducci√≥n en Tiempo Real

```mermaid
sequenceDiagram
    participant U as Usuario
    participant F as Frontend
    participant B as Backend
    participant AI as OpenAI
    participant DB as MongoDB
    
    U->>F: Escribe texto para traducir
    F->>B: POST /api/generate/translate (stream)
    B->>AI: Traduce texto con contexto
    AI-->>B: Stream de traducci√≥n
    B-->>F: Stream de traducci√≥n
    F-->>U: Muestra traducci√≥n en tiempo real
    B->>DB: Opcional: guardar en historial
```

---

## üóÑÔ∏è Estructura de Base de Datos

### 9. Modelos de Datos

```mermaid
erDiagram
    USER {
        string _id
        string email
        string password
        string role
        date createdAt
        date updatedAt
    }
    
    WORD {
        string _id
        string word
        string definition
        array examples
        array type
        string IPA
        number seen
        string img
        string level
        array sinonyms
        array codeSwitching
        string language
        object spanish
        array chat
        date lastReviewed
        date nextReview
        number reviewCount
        number difficulty
        number interval
        number easeFactor
    }
    
    EXPRESSION {
        string _id
        string expression
        string definition
        array examples
        array type
        string context
        string difficulty
        string img
        string language
        object spanish
        array chat
    }
    
    EXAM {
        string _id
        string title
        string examSlug
        array questions
        string level
        string topic
        array grammarTopics
        number difficulty
        string userLang
        date createdAt
    }
    
    QUESTION {
        string _id
        string text
        string type
        array options
        array correctAnswers
        array tags
        string explanation
        string examId
    }
    
    USER ||--o{ EXAM : creates
    EXAM ||--o{ QUESTION : contains
    USER ||--o{ WORD : studies
    USER ||--o{ EXPRESSION : studies
```

---

## üîê Flujo de Autenticaci√≥n y Autorizaci√≥n

### 10. Middleware de Seguridad

```mermaid
flowchart TD
    A[Request HTTP] --> B{¬øTiene token?}
    B -->|No| C[401 Unauthorized]
    B -->|S√≠| D[Validar token JWT]
    D --> E{¬øToken v√°lido?}
    E -->|No| F[401 Unauthorized]
    E -->|S√≠| G{¬øUsuario existe?}
    G -->|No| H[401 Unauthorized]
    G -->|S√≠| I[Agregar user a req]
    I --> J[Continuar a controlador]
    
    style A fill:#e1f5fe
    style J fill:#c8e6c9
    style C fill:#ffcdd2
    style F fill:#ffcdd2
    style H fill:#ffcdd2
```

---

## üìä Flujo de Logging y Monitoreo

### 11. Sistema de Logging Estructurado

```mermaid
flowchart TD
    A[Operaci√≥n inicia] --> B[Generar operationId]
    B --> C[Log inicio con contexto]
    C --> D[Validar input]
    D --> E{¬øValidaci√≥n exitosa?}
    E -->|No| F[Log warning + error]
    E -->|S√≠| G[Ejecutar operaci√≥n]
    G --> H{¬øOperaci√≥n exitosa?}
    H -->|No| I[Log error con stack]
    H -->|S√≠| J[Log √©xito con m√©tricas]
    
    J --> K[Retornar respuesta]
    I --> L[Retornar error]
    F --> L
    
    style A fill:#e1f5fe
    style K fill:#c8e6c9
    style L fill:#ffcdd2
```

---

## üöÄ Optimizaciones y Mejores Pr√°cticas

### 12. Estrategias de Rendimiento

```mermaid
graph LR
    subgraph "Caching"
        A[Cache de palabras frecuentes]
        B[Cache de expresiones populares]
        C[Cache de ex√°menes por nivel]
    end
    
    subgraph "Rate Limiting"
        D[L√≠mite por IP]
        E[L√≠mite por usuario]
        F[L√≠mite por endpoint]
    end
    
    subgraph "Streaming"
        G[Respuestas en tiempo real]
        H[Chat streaming]
        I[Generaci√≥n progresiva]
    end
    
    subgraph "Validaci√≥n"
        J[Validaci√≥n de entrada]
        K[Validaci√≥n de salida AI]
        L[Sanitizaci√≥n de datos]
    end
```

---

## üîß Configuraci√≥n y Variables de Entorno

### 13. Configuraci√≥n del Sistema

```mermaid
graph TD
    A[Variables de Entorno] --> B[OpenAI API Key]
    A --> C[Cloudinary Config]
    A --> D[MongoDB URI]
    A --> E[JWT Secret]
    A --> F[Rate Limit Config]
    
    B --> G[Servicios de IA]
    C --> H[Almacenamiento de im√°genes]
    D --> I[Conexi√≥n a base de datos]
    E --> J[Autenticaci√≥n JWT]
    F --> K[L√≠mites de API]
```

---

## üìà M√©tricas y Monitoreo

### 14. KPIs del Sistema

```mermaid
graph LR
    subgraph "Rendimiento"
        A[Latencia de respuesta]
        B[Throughput de requests]
        C[Tasa de √©xito de IA]
    end
    
    subgraph "Calidad"
        D[Precisi√≥n de generaci√≥n]
        E[Relevancia de contenido]
        F[Satisfacci√≥n del usuario]
    end
    
    subgraph "Uso"
        G[Usuarios activos]
        H[Contenido generado]
        I[Interacciones de chat]
    end
```

---

## üéØ Puntos Clave del Sistema

1. **Arquitectura Modular**: Separaci√≥n clara entre controladores, servicios y rutas
2. **Streaming en Tiempo Real**: Chat y generaci√≥n de contenido con respuesta inmediata
3. **Validaci√≥n Robusta**: M√∫ltiples capas de validaci√≥n para entrada y salida
4. **Logging Estructurado**: Sistema completo de monitoreo y debugging
5. **Manejo de Errores**: Gesti√≥n consistente de errores con c√≥digos espec√≠ficos
6. **Seguridad**: Autenticaci√≥n JWT y validaci√≥n de permisos
7. **Escalabilidad**: Dise√±o preparado para crecimiento y optimizaci√≥n
8. **Integraci√≥n AI**: M√∫ltiples servicios de OpenAI para diferentes funcionalidades

---

## üîÆ Futuras Mejoras

- **Cache Inteligente**: Implementar Redis para cache distribuido
- **Microservicios**: Separar servicios de IA en contenedores independientes
- **ML Pipeline**: Pipeline de machine learning para mejorar calidad de contenido
- **Analytics Avanzado**: M√©tricas detalladas de uso y aprendizaje
- **A/B Testing**: Sistema para probar diferentes prompts y configuraciones
- **Backup Autom√°tico**: Sistema de respaldo autom√°tico de contenido generado
